#include <Arduino.h>
#include <SPI.h>

static const int PIN_SCK  = 18;
static const int PIN_MOSI = 17;
static const int PIN_MISO = 16;
static const int PIN_CS   = 15;

// 如果从机处理不过来，可以先降到 100000
SPISettings ensSettings(1000000, MSBFIRST, SPI_MODE0);

static void spi_xfer_4bytes(const uint8_t tx[4], uint8_t rx[4])
{
  SPI.beginTransaction(ensSettings);
  digitalWrite(PIN_CS, LOW);
  delayMicroseconds(10);

  for (int i = 0; i < 4; i++) {
    rx[i] = SPI.transfer(tx[i]);
  }

  delayMicroseconds(10);
  digitalWrite(PIN_CS, HIGH);
  SPI.endTransaction();
}

void setup()
{
  Serial.begin(115200);
  delay(300);

  pinMode(PIN_CS, OUTPUT);
  digitalWrite(PIN_CS, HIGH);

  SPI.begin(PIN_SCK, PIN_MISO, PIN_MOSI, PIN_CS);

  Serial.println("ESP32-S3 SPI master ready. Send 11223344 -> 22334455 -> 33445566 loop.");
}

void loop()
{
  static uint8_t step = 0;

  // ✅ 写死三组，绝对不会乱序
  static const uint8_t patterns[3][4] = {
    {0x11, 0x22, 0x33, 0x44},
    {0x22, 0x33, 0x44, 0x55},
    {0x33, 0x44, 0x55, 0x66},
  };

  uint8_t tx[4] = { patterns[step][0], patterns[step][1], patterns[step][2], patterns[step][3] };
  uint8_t rx[4] = {0};

  spi_xfer_4bytes(tx, rx);

  Serial.print("STEP "); Serial.print(step);
  Serial.print("  TX=");
  for (int i = 0; i < 4; i++) { Serial.print(" "); Serial.print(tx[i], HEX); }
  Serial.print("  | RX=");
  for (int i = 0; i < 4; i++) { Serial.print(" "); Serial.print(rx[i], HEX); }
  Serial.println();

  step = (step + 1) % 3;
  delay(800);
}
